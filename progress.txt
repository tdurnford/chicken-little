## 2026-01-16 - Fix Predator Targeting Inconsistency (ID #6)

### Summary
Fixed a bug where predators would visually target one chicken but actually capture a different chicken during attacks.

### Problem
The `PredatorAttack.executeAttack` function was using `selectChickensForAttack` which randomly selected chickens to capture, completely ignoring the `targetChickenId` that was set by the predator AI for visual targeting. This caused a disconnect between what the player saw (predator approaching chicken A) and what actually happened (chicken B gets captured).

### Solution
Modified `selectChickensForAttack` in `src/shared/PredatorAttack.lua` to:
1. Accept an optional `targetChickenId` parameter
2. Prioritize the targeted chicken when selecting chickens for attack (if it exists and is not protected)
3. Fill remaining attack slots with random chickens as before

Also updated `executeAttack` to pass the predator's `targetChickenId` from the spawn state to the selection function.

### Files Changed
- `src/shared/PredatorAttack.lua` - Modified `selectChickensForAttack` and `executeAttack` functions
- `src/shared/IntegrationTests.lua` - Added import for PredatorAttack, added test for targeted chicken priority

### Testing
- Added integration test `"PredatorAttack: executeAttack prioritizes targeted chicken"`
- Format check passes with `stylua`

### Notes for Next Developer
- The predator targeting now correctly prioritizes the chicken it's visually approaching
- If the targeted chicken is protected (newly placed within 15 seconds), a random chicken will be selected instead
- The `PredatorSpawning.updateTargetChicken` function is used by the server to set which chicken a predator is targeting

---

## 2026-01-16 - Implement Player Leveling System (ID #2)

### Summary
Added a complete player leveling system with XP requirements, level-based difficulty scaling for predators, and HUD display for level/XP progress.

### Features Implemented
1. **LevelConfig Module** (`src/shared/LevelConfig.lua`)
   - XP requirements per level (base 100 XP, scaling 15% per level)
   - Max level: 100
   - Functions: `getLevelFromXP`, `getXPForLevel`, `getLevelProgress`, `getXPToNextLevel`
   - Max predators scale with level (1 at level 1, up to 8 at high levels)
   - Threat level unlocks: Minor(1), Moderate(5), Dangerous(15), Severe(30), Deadly(50), Catastrophic(75)

2. **PlayerData Updates** (`src/shared/PlayerData.lua`)
   - Added `level` and `xp` fields to `PlayerDataSchema`
   - New functions: `getLevel`, `getXP`, `addXP`, `setLevelAndXP`
   - `addXP` returns new level when player levels up

3. **PredatorSpawning Updates** (`src/shared/PredatorSpawning.lua`)
   - `SpawnState` now includes `playerLevel`
   - `createSpawnState(playerLevel)` accepts player level
   - `getMaxActivePredators` now uses `LevelConfig.getMaxPredatorsForLevel`
   - `selectPredatorForWave` respects threat level unlocks based on player level
   - `setPlayerLevel` function for updating level on spawn state

4. **MainHUD Level Display** (`src/client/MainHUD.lua`)
   - Level badge in top-left corner showing "Level X"
   - XP progress bar below level text
   - `setLevelAndXP(level, xp, progress)` function
   - `showLevelUp(newLevel, unlocks)` celebration notification
   - `showXPGain(amount)` floating XP text

5. **Remote Events** (`src/server/RemoteSetup.lua`)
   - Added `XPGained` and `LevelUp` events

### Files Changed
- `src/shared/LevelConfig.lua` - NEW: Level configuration and XP calculations
- `src/shared/PlayerData.lua` - Added level/xp fields and helper functions
- `src/shared/PredatorSpawning.lua` - Level-based predator scaling
- `src/client/MainHUD.lua` - Level/XP HUD display and level-up effects
- `src/server/RemoteSetup.lua` - Added XPGained and LevelUp events
- `src/shared/IntegrationTests.lua` - Added 12 new tests for leveling system

### Testing
- Added integration tests for LevelConfig functions
- Added tests for PlayerData XP/level functions
- Added tests for PredatorSpawning level integration
- Format check passes with `stylua`

### Notes for Next Developer
- XP reward system (ID #7) should use `PlayerData.addXP()` to award XP for actions
- When `addXP` returns a number (new level), fire the `LevelUp` remote to show celebration
- Call `PredatorSpawning.setPlayerLevel(state, level)` when player levels up to update spawning
- The client should call `MainHUD.setLevelAndXP()` when receiving `PlayerDataChanged`
- Threat level unlocks mean players won't face Bears until level 75

---

## 2026-01-16 - Implement XP Reward System (ID #7)

### Summary
Added a complete XP reward system that awards XP for various player actions, making the leveling system (ID #2) meaningful.

### Features Implemented
1. **XPConfig Module** (`src/shared/XPConfig.lua`)
   - Base XP rewards for 6 action types
   - Rarity multipliers: Common(1x) to Mythic(32x)
   - Threat level multipliers: Minor(1x) to Catastrophic(32x)
   - Functions: `calculatePredatorKillXP`, `calculateChickenHatchXP`, `calculateRandomChickenXP`, `calculateEggCollectedXP`, `calculateTrapCatchXP`, `calculateDayNightCycleXP`

2. **XP Rewards Integrated**
   - Killing predators: 25 XP base, scaled by threat level (Rat=25, Bear=800)
   - Hatching chickens: 10 XP base, scaled by rarity (Common=10, Mythic=320)
   - Catching random chickens: 50 XP base, scaled by rarity
   - Collecting eggs: 5 XP base, scaled by rarity
   - Surviving night cycles: 15 XP flat

3. **Server Integration** (`src/server/Main.server.lua`)
   - Added `awardXP()` helper function for XP rewards and level-up handling
   - Fires `XPGained` event to show floating XP text
   - Fires `LevelUp` event when player reaches new level with unlock info
   - Night cycle completion tracking for XP awards

4. **Client Integration** (`src/client/Main.client.lua`)
   - Added `XPGained` event handler to show XP gain notifications
   - Added `LevelUp` event handler to show level-up celebrations

5. **Sound Effects** (`src/client/SoundEffects.lua`)
   - Added `xpGain` and `levelUp` sound configurations

### XP Reward Values
| Action | Base XP | Multiplier |
|--------|---------|------------|
| Kill Predator | 25 | Threat level (1-32x) |
| Hatch Chicken | 10 | Rarity (1-32x) |
| Catch Random Chicken | 50 | Rarity (1-32x) |
| Collect Egg | 5 | Rarity (1-32x) |
| Trap Catch Predator | 35 | Threat level (1-32x) |
| Survive Night | 15 | Flat |

### Files Changed
- `src/shared/XPConfig.lua` - NEW: XP reward configuration
- `src/server/Main.server.lua` - XP reward integration for all actions
- `src/client/Main.client.lua` - XPGained and LevelUp event handlers
- `src/client/SoundEffects.lua` - Added xpGain and levelUp sounds
- `src/shared/IntegrationTests.lua` - Added 8 tests for XPConfig

### Testing
- Added 8 integration tests for XPConfig functions
- Format check passes with `stylua`

### Notes for Next Developer
- The XP system now makes the leveling system (ID #2) meaningful
- Players receive XP notifications via `MainHUD.showXPGain(amount)`
- Level-up celebrations show via `MainHUD.showLevelUp(newLevel, unlocks)`
- Night cycle XP is awarded to all online players when night ends (dawn transition)
- Trap catch XP would need integration in `SellPredator` when trap predator selling is implemented

